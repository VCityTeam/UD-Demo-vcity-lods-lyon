<!-- @format -->

<!DOCTYPE html>
<html>
  <head>
    <title>3DTiles of all Lyon boroughs with LODs</title>
    <link rel="stylesheet" href="../css/view.css" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div id="view_container"></div>
    <div id="logo_div">
      <img class="logo" src="../assets/img/logo-imu.png" />
      <img class="logo" src="../assets/img/logo-liris.png" />
    </div>
    <div id="widgets_container">
      <button id="reverse_button">Reverse 3DTiles process</button>
      <button id="switch_button">Switch position reference</button>
    </div>
    <script src="../dist/production/bundle.js"></script>
    <!-- <script src="../dist/development/bundle.js"></script> -->
    <script type="text/javascript">
      app
        .loadMultipleJSON(['../assets/config/all_lyon_lods.json'])
        .then((configs) => {
          const config = configs['all_lyon_lods'];

          const crs = config.crs.name;
          app.proj4.default.defs(crs, config.crs.transform);

          const extent = new app.itowns.Extent(
            crs,
            config.extent.west,
            config.extent.east,
            config.extent.south,
            config.extent.north
          );

          // ADD VIEWS
          const camera = config.camera;
          const placement = {
            coord: new app.itowns.Coordinates(crs, camera.x, camera.y),
            range: camera.range,
            tilt: camera.tilt,
            heading: camera.heading,
          };

          const viewDomElement = document.getElementById('view_container');
          const view = new app.itowns.PlanarView(viewDomElement, extent, {
            maxSubdivisionLevel: 7,
            placement: placement,
          });
          app.initScene(
            view.camera.camera3D,
            view.mainLoop.gfxEngine.renderer,
            view.scene
          );

          // ADD LAYERS
          const c3dTilesLayers = [];
          config['3DTiles'].forEach((conf) => {
            const layer = app.C3DTilesLayer(conf, view);
            layer.style = new app.itowns.Style({
              fill: {
                color: conf.color || 'white',
              },
            });
            c3dTilesLayers.push(layer);
            app.itowns.View.prototype.addLayer.call(view, layer);
          });

          // ADD WIDGET
          const widget = new app.C3DTiles(view, {
            parentElement: document.getElementById('widgets_container'),
            layerContainerClassName: 'widgets-3dtiles-layer-container',
            c3DTFeatureInfoContainerClassName:
              'widgets-3dtiles-feature-container',
            urlContainerClassName: 'widgets-3dtiles-url-container',
          });
          widget.domElement.setAttribute('id', 'widget_3dtiles');

          const contextSelection = {
            feature: null,
            layer: null,
          };
          view.domElement.onclick = (event) => {
            app.addClick3DTilesClickEvent(
              view,
              widget,
              event,
              contextSelection
            );
          };

          // ADD REFINEMENT BUTTONS
          app.setLayersDefaultRefinement(c3dTilesLayers);
          let useCameraPosition = false;

          window.addEventListener(
            'mousemove',
            (event) => {
              if (useCameraPosition) return;
              const intersects = view.pickObjectsAt(
                event,
                0,
                view
                  .getLayers()
                  .find((el) => el.id == '3d-tiles-layer-relief')
              );

              if (intersects.length) {
                app.setMousePosition(intersects[0].point);
                view.notifyChange(view.camera3D);
              }
            },
            false
          );
          const reverseButton = document.getElementById('reverse_button');
          reverseButton.onclick = function () {
            app.reverseRefinement(c3dTilesLayers);
            view.notifyChange(view.camera3D);
          };

          const switchButton = document.getElementById('switch_button');
          switchButton.onclick = function () {
            useCameraPosition = app.switchPositionReference();
          };
        });
    </script>
  </body>
</html>
